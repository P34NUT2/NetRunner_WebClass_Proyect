#########################################
# Postgresito como DB
#########################################
services:
  postgres:
    image: postgres:15
    container_name: postgres_db
    restart: always
    environment:
      POSTGRES_USER: webdev
      POSTGRES_PASSWORD: InsecurePasswd
      POSTGRES_DB: netrunner
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - netrunner_network

#########################################
# Terminal grÃ¡fica para PostgreSQL
#########################################
  ##se que este no lo ocupa usted pero me sirve para meter datos 
  ##y manejarlos desde ahi igual se lo dejo por si quiere usar este docker
  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@dev.com
      PGADMIN_DEFAULT_PASSWORD: InsecurePasswd
    ports:
      - "8080:80"
    depends_on:
      - postgres
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - netrunner_network

########################################################
# Ollama para IA (dolphin-llama3 + netrunner)
########################################################
##lo deje con los puertos default que venian en la documentacion
  ollama:
    image: ollama/ollama:latest
    container_name: netrunner_ollama
    restart: always
    ports:
      - "11434:11434"
    volumes:
      # Guardar modelos descargados (2-10GB)
      - ollama_data:/root/.ollama
      # Montar el Modelfile tiny para crear modelo personalizado
      - ./netrunner-tiny:/netrunner-tiny:ro
    networks:
      - netrunner_network
    environment:
      - OLLAMA_HOST=0.0.0.0
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 3

########################################################
# Script para auto-setup de modelos:
# 1. Descarga dolphin-llama3 (base uncensored)
# 2. Crea modelo netrunner (personalizado con tÃ©cnicas CTF)
# NOTA: Solo descarga/crea si NO existe (verifica primero)
# Los modelos se guardan en ollama_data (persistente)
########################################################
  ollama-pull:
    image: docker:cli
    container_name: ollama_model_puller
    depends_on:
      ollama:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    entrypoint: /bin/sh
    command: >
      -c "
      echo 'ðŸš€ [1/2] Descargando dolphin-llama3 (uncensored)...';
      docker exec netrunner_ollama ollama pull dolphin-llama3;
      echo 'âœ… dolphin-llama3 listo!';
      echo '';
      echo 'ðŸ§  [2/2] Creando modelo netrunner (CTF personalizado)...';
      docker exec netrunner_ollama ollama create netrunner -f /netrunner-tiny;
      echo 'âœ… Modelo netrunner creado!';
      echo '';
      echo 'ðŸŽ‰ Setup completo! NetRunner AI estÃ¡ listo para usar.';
      "
    restart: "no"

#########################################
# Backend (Node.js + Express + Prisma)
#########################################
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: netrunner_backend
    restart: always
    ports:
      - "3001:3001"
    env_file:
      - ./backend/.env.docker
    depends_on:
      - postgres
      - ollama
    networks:
      - netrunner_network
    # volumes:
      # Volumen para desarrollo con hot reload (descomentar si quieres ver cambios en tiempo real)
      # - ./backend:/app
      # - /app/node_modules

#########################################
# Frontend (Next.js)
#########################################
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: netrunner_frontend
    restart: always
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:3001
    depends_on:
      - backend
    networks:
      - netrunner_network

#########################################
# Redes
#########################################
networks:
  netrunner_network:
    driver: bridge

#########################################
# VolÃºmenes
#########################################
volumes:
  postgres_data:
  pgadmin_data:
  ollama_data:
